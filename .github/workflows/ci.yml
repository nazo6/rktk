name: check

on:
  push:
    branches: ["master"]
  pull_request:

env:
  CARGO_TERM_COLOR: always

jobs:
  paths-filter:
    runs-on: ubuntu-latest
    outputs:
      rust: ${{ steps.filter.outputs.rust }}
      rrp-web: ${{ steps.filter.outputs.rrp-web }}
    steps:
    - uses: actions/checkout@v4
    - uses: dorny/paths-filter@v3
      id: filter
      with:
        filters: |
          rust:
            - '.github/workflows/*.yml'
            - '**.toml'
            - '**.rs'
            - '**.lock'
          rrp-web:
            - '.github/workflows/*.yml'
            - 'rrp-web/**'

  lib-check:
    runs-on: ubuntu-latest
    needs: paths-filter
    if: needs.paths-filter.outputs.rust == 'true'
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup rust
      uses: ./.github/workflows/setup-rust

    - name: Run rust check
      run: cargo make check-all

    - name: Build rust library for rrp-web
      run: cd rrp-web/rrp-client-web && wasm-pack build --release

    - name: Upload rrp-web-client package
      uses: actions/upload-artifact@v4
      with:
        name: rrp-client-web
        path: rrp-web/rrp-client-web/pkg

  # split job is splitted because by executing test cache becomes dirty
  lib-test:
    runs-on: ubuntu-latest
    needs: paths-filter
    if: needs.paths-filter.outputs.rust == 'true'
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup rust
      uses: ./.github/workflows/setup-rust

    - name: Run rust test
      run: cargo make test-all

  rrp-web-check:
    runs-on: ubuntu-latest
    if: ${{ always() }}
    needs: lib-check
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Download rrp-client-web packages
      uses: actions/download-artifact@v4
      with:
        name: rrp-client-web
        path: rrp-web/rrp-client-web/pkg

    - uses: pnpm/action-setup@v4
      name: Setup pnpm
      with:
        version: 9
        run_install: false

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'pnpm'
        cache-dependency-path: rrp-web/pnpm-lock.yaml

    - name: pnpm install
      run: cd rrp-web && pnpm install

    - name: Type check rrp-web
      run: cd rrp-web && pnpm tsc --noEmit
